<!DOCTYPE html>
<html lang="en">

<head>
  <style>
    #login,
    #messages {
      width: 80% height: 300px
    }

    #messages {
      display: none
    }

    #conversations {
      display: none
    }
  </style>
  <script src="./node_modules/nexmo-conversation/dist/conversationClient.js"></script>
</head>

<body>

  <form id="login">
    <h1>Login</h1>
    <input type="text" name="username" value="">
    <input type="submit" value="Login" />
  </form>

  <section id="messages">
    <h1>Messages</h1>

    <div id="messageFeed"></div>

    <textarea id="messageTextarea"></textarea>
    <br>
    <button id="send">Send</button>
  </section>

  <section id="conversations">
    <h1>Conversations</h1>
  </section>

  <script>
    const USER_JWT = 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE1MTI2NTgwMjAsImp0aSI6IjdiNzhkZjUwLWRiNWQtMTFlNy1iM2QwLTk3YzBhOTg1MDRkOSIsImFwcGxpY2F0aW9uX2lkIjoiYTRiNGZlMzEtMjFlOS00YjU5LTlkZjgtMjExNTY4MWU3ZTAwIiwic3ViIjoiamFtaWUiLCJleHAiOjE1MTI2NTgxMDcyMDUsImFjbCI6eyJwYXRocyI6eyIvdjEvc2Vzc2lvbnMvKioiOnt9LCIvdjEvdXNlcnMvKioiOnt9LCIvdjEvY29udmVyc2F0aW9ucy8qKiI6e319fX0.bIfUi4yu6sUGiRTRU6XSGsqtxl8OOp3p311lxs_ujifTJFWCa9n8p0aMF8yGaGjLpCkCgTl6ZKeArq71QE_qOtNTEJH8eyizyOm2GZYPqTh4mNOlG_jBOTMJOVqsVcCeX8URcBBZcQPTWVxeki7Js4TghDsaq4HJhp1cFcLFTm-tMTlrgpwqoBokTcoR_85URwSxeX4Bg3GTVdzKmL2LctEW1xesDE356FbRYca0mHaNSVTN8tvPIBZXkg1-5kOvSJ-m2OPe_gIDkLYoPt3XZoBuKHTLhbCCFheahag5_bBCiQwRg8oW7fmo3RR6VFNvc2kKZLrh7rhT4wcrS8pGDQ'
    const YOUR_CONVERSATION_ID = 'CON-c62fd5dd-fe8f-48fa-9cee-a044edf0a629'
    const SECOND_USER_JWT = 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE1MTI2NTgwMjAsImp0aSI6IjdiNzk1NDgwLWRiNWQtMTFlNy1iM2QwLTk3YzBhOTg1MDRkOSIsImFwcGxpY2F0aW9uX2lkIjoiYTRiNGZlMzEtMjFlOS00YjU5LTlkZjgtMjExNTY4MWU3ZTAwIiwic3ViIjoiaW5zZXJ0WW91clVzZXJuYW1lSGVyZSIsImV4cCI6MTUxMjY1ODEwNzIwOCwiYWNsIjp7InBhdGhzIjp7Ii92MS9zZXNzaW9ucy8qKiI6e30sIi92MS91c2Vycy8qKiI6e30sIi92MS9jb252ZXJzYXRpb25zLyoqIjp7fX19fQ.v3-o5lcsGuWMYRNvwHt5kp_5zQR0Y1vwyLNKZoloFdEp6jer9dvc6KbE8AhZDdxv7FLeAsU4eccHpDmND1YF9LZwHF9e93gIoICCYwq0NyBcGiWHg51USplYpWduTooLAg__FpTWbxwV-rB00RCPWt46z6bSJynwd2_OUDaiVoA_Qer2qLBGgBeh7AAVDYjH1dwIsejzvytIUZQXoYQZ2dX030wM5CEobnxKWW9JTX6w3edLvu5oHgfgNnH6ykRWQYJ_Hftf0EvQEfUMDa41ud-3gYDl4GKRJqukMwUdt-fNOKYNVPaw9heGKum3POq-vZrZXg1rXaOweGwiKndCxw'

    class ChatApp {
      constructor() {
        this.messageTextarea = document.getElementById('messageTextarea')
        this.messageFeed = document.getElementById('messageFeed')
        this.sendButton = document.getElementById('send')
        this.loginForm = document.getElementById('login')
        this.conversationList = document.getElementById('conversations')
        this.setupUserEvents()
      }

      errorLogger(error) {
        console.log(error)
      }

      eventLogger(event) {
        return () => {
          console.log("'%s' event was sent", event)
        }
      }

      authenticate(username) {
        return username.toLowerCase() === "jamie" ? USER_JWT : SECOND_USER_JWT
      }

      setupConversationEvents(conversation) {
        this.conversation = conversation
        this.conversationList.style.display = 'none'
        document.getElementById("messages").style.display = "block"
        console.log('*** Conversation Retrieved', conversation)
        console.log('*** Conversation Member', conversation.me)

        // Bind to events on the conversation
        conversation.on('text', (sender, message) => {
          console.log('*** Message received', sender, message)
          const date = new Date(Date.parse(message.timestamp))
          const text = `${sender.name} @ ${date}: <b>${message.body.text}</b><br>`
          this.messageFeed.innerHTML = text + this.messageFeed.innerHTML
        })

        conversation.on("member:joined", (data, info) => {
          console.log(`*** ${info.user.name} joined the conversation`)
          const text = `${info.user.name} @ ${date}: <b>joined the conversation</b><br>`
          this.messageFeed.innerHTML = text + this.messageFeed.innerHTML
        })
      }

      updateConversationsList(conversations) {
        let conversationsElement = document.createElement("ul")
        for (let id in conversations) {
          let conversationElement = document.createElement("li")
          conversationElement.textContent = conversations[id].display_name
          conversationElement.addEventListener("click", () => this.setupConversationEvents(conversations[id]))
          conversationsElement.appendChild(conversationElement)
        }

        if (!conversationsElement.childNodes.length) {
          conversationsElement.textContent = "You are not a member of any conversations"
        }

        this.conversationList.appendChild(conversationsElement)
        this.conversationList.style.display = 'block'
        this.loginForm.style.display = 'none'
      }


      listConversations(userToken) {

        new ConversationClient({
            debug: false
          })
          .login(userToken)
          .then(app => {
            console.log('*** Logged into app', app)

            app.on("member:invited", (data, invitation) => {
              //identify the sender.
              console.log("*** Invitation received:", invitation);

              //accept an invitation.
              app.getConversation(invitation.cid || invitation.body.cname)
                .then((conversation) => {
                  this.conversation = conversation
                  conversation.join().then(() => {
                    var conversationDictionary = {}
                    conversationDictionary[this.conversation.id] = this.conversation
                    this.updateConversationsList(conversationDictionary)
                  }).catch(this.errorLogger)

                })
                .catch(this.errorLogger)
            })
            return app.getConversations()
          })
          .then((conversations) => {
            console.log('*** Retrieved conversations', conversations)

            this.updateConversationsList(conversations)

          })
          .catch(this.errorLogger)
      }

      setupUserEvents() {
        this.sendButton.addEventListener('click', () => {
          this.conversation.sendText(this.messageTextarea.value).then(() => {
            this.eventLogger('text')()
            this.messageTextarea.value = ''
          }).catch(this.errorLogger)

        })

        this.loginForm.addEventListener('submit', (event) => {
          event.preventDefault()
          const userToken = this.authenticate(this.loginForm.children.username.value)
          if (userToken) {
            this.listConversations(userToken)
          }
        })
      }
    }

    new ChatApp()
  </script>
</body>

</html>
